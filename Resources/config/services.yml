parameters:
    # The directory (inside each bundle) where to look for migrations definitions
    # NB: this pasrasmeter will be renamed in v3
    kaliop_bundle_migration.version_directory: 'MigrationVersions'
    # The dtabase table used to store migration information. Will be created automatically
    ez_migration_bundle.table_name: 'kaliop_migrations'
    # Used to discriminate valid migration definitions
    ez_migration_bundle.valid_databases:
        # names have to correspond to doctrine 'platform', short of version numbers and lowercase
        # NB: this does NOT mean that eZPublish supports all of them :-)
        - 'mysql'
        - 'postgresql'
        - 'oracle'
        - 'sqlite'
        - 'drizzle'
        - 'sqlserver'
        - 'sqlanywhere'

    # Deprecated paremeter. Left in for the v1-to-v2 migration to work. Will be removed in v3
    kaliop_bundle_migration.table_name: 'kaliop_versions'

    ez_migration_bundle.migration_service.class: Kaliop\eZMigrationBundle\Core\MigrationService

    ez_migration_bundle.loader.filesystem.class: Kaliop\eZMigrationBundle\Core\Loader\Filesystem

    ez_migration_bundle.definition_parser.yaml.class: Kaliop\eZMigrationBundle\Core\DefinitionParser\YamlDefinitionParser
    ez_migration_bundle.definition_parser.json.class: Kaliop\eZMigrationBundle\Core\DefinitionParser\JsonDefinitionParser
    ez_migration_bundle.definition_parser.sql.class: Kaliop\eZMigrationBundle\Core\DefinitionParser\SQLDefinitionParser
    ez_migration_bundle.definition_parser.php.class: Kaliop\eZMigrationBundle\Core\DefinitionParser\PHPDefinitionParser

    ez_migration_bundle.storage_handler.database.class: Kaliop\eZMigrationBundle\Core\StorageHandler\Database

    ez_migration_bundle.executor.php.class: Kaliop\eZMigrationBundle\Core\Executor\PHPExecutor
    ez_migration_bundle.executor.sql.class: Kaliop\eZMigrationBundle\Core\Executor\SQLExecutor
    ez_migration_bundle.executor.repository.class: Kaliop\eZMigrationBundle\Core\Executor\RepositoryExecutor

    ez_migration_bundle.executor.content_manager.class: Kaliop\eZMigrationBundle\Core\Executor\ContentManager
    ez_migration_bundle.executor.content_type_manager.class: Kaliop\eZMigrationBundle\Core\Executor\ContentTypeManager
    ez_migration_bundle.executor.content_type_group_manager.class: Kaliop\eZMigrationBundle\Core\Executor\ContentTypeGroupManager
    ez_migration_bundle.executor.location_manager.class: Kaliop\eZMigrationBundle\Core\Executor\LocationManager
    ez_migration_bundle.executor.role_manager.class: Kaliop\eZMigrationBundle\Core\Executor\RoleManager
    ez_migration_bundle.executor.tag_manager.class: Kaliop\eZMigrationBundle\Core\Executor\TagManager
    ez_migration_bundle.executor.user_group_manager.class: Kaliop\eZMigrationBundle\Core\Executor\UserGroupManager
    ez_migration_bundle.executor.user_manager.class: Kaliop\eZMigrationBundle\Core\Executor\UserManager
    ez_migration_bundle.executor.language_manager.class: Kaliop\eZMigrationBundle\Core\Executor\LanguageManager
    ez_migration_bundle.executor.object_state_manager.class: Kaliop\eZMigrationBundle\Core\Executor\ObjectStateManager
    ez_migration_bundle.executor.object_state_group_manager.class: Kaliop\eZMigrationBundle\Core\Executor\ObjectStateGroupManager

    ez_migration_bundle.content_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\ContentMatcher
    ez_migration_bundle.location_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\LocationMatcher
    ez_migration_bundle.user_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\UserMatcher
    ez_migration_bundle.user_group_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\UserGroupMatcher
    ez_migration_bundle.role_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\RoleMatcher
    ez_migration_bundle.content_type_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\ContentTypeMatcher
    ez_migration_bundle.section_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\SectionMatcher
    ez_migration_bundle.object_state_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\ObjectStateMatcher
    ez_migration_bundle.object_state_group_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\ObjectStateGroupMatcher
    ez_migration_bundle.content_type_group_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\ContentTypeGroupMatcher
    ez_migration_bundle.tag_matcher.class: Kaliop\eZMigrationBundle\Core\Matcher\TagMatcher

    ez_migration_bundle.complex_field_manager.class: Kaliop\eZMigrationBundle\Core\ComplexField\ComplexFieldManager
    ez_migration_bundle.complex_field.ezauthor.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzAuthor
    ez_migration_bundle.complex_field.ezbinaryfile.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzBinaryFile
    ez_migration_bundle.complex_field.ezboolean.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzBoolean
    ez_migration_bundle.complex_field.ezdate.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzDate
    ez_migration_bundle.complex_field.ezdatetime.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzDateAndTime
    ez_migration_bundle.complex_field.ezimage.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzImage
    ez_migration_bundle.complex_field.ezpage.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzPage
    ez_migration_bundle.complex_field.ezrelation.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzRelation
    ez_migration_bundle.complex_field.ezrelationlist.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzRelationList
    ez_migration_bundle.complex_field.ezrichtext.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzRichText
    ez_migration_bundle.complex_field.ezxmltext.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzXmlText
    ez_migration_bundle.complex_field.eztags.class: Kaliop\eZMigrationBundle\Core\ComplexField\EzTags

    ez_migration_bundle.reference_resolver.chain.class: Kaliop\eZMigrationBundle\Core\ReferenceResolver\ChainResolver
    ez_migration_bundle.reference_resolver.chain_prefix.class: Kaliop\eZMigrationBundle\Core\ReferenceResolver\ChainPrefixResolver
    ez_migration_bundle.reference_resolver.customreference.class: Kaliop\eZMigrationBundle\Core\ReferenceResolver\CustomReferenceResolver
    ez_migration_bundle.reference_resolver.content.class: Kaliop\eZMigrationBundle\Core\ReferenceResolver\ContentResolver
    ez_migration_bundle.reference_resolver.location.class: Kaliop\eZMigrationBundle\Core\ReferenceResolver\LocationResolver
    ez_migration_bundle.reference_resolver.tag.class: Kaliop\eZMigrationBundle\Core\ReferenceResolver\TagResolver

    ez_migration_bundle.helper.limitation_converter.class: Kaliop\eZMigrationBundle\Core\Helper\LimitationConverter
    ez_migration_bundle.helper.console_io.class: Kaliop\eZMigrationBundle\Core\Helper\ConsoleIO

    ez_migration_bundle.step_executed_listener.tracing.class: Kaliop\eZMigrationBundle\Core\EventListener\TracingStepExecutedListener

services:

    ez_migration_bundle.migration_service:
        class: '%ez_migration_bundle.migration_service.class%'
        arguments:
            - '@ez_migration_bundle.loader'
            - '@ez_migration_bundle.storage_handler'
            - '@ezpublish.api.repository'
            - '@event_dispatcher'

    ### loaders

    ez_migration_bundle.loader:
        alias: ez_migration_bundle.loader.filesystem

    ez_migration_bundle.loader.filesystem:
        class: '%ez_migration_bundle.loader.filesystem.class%'
        arguments:
            - '@kernel'
            - '%kaliop_bundle_migration.version_directory%'

    ### parsers

    ez_migration_bundle.definition_parser.yaml:
        class: '%ez_migration_bundle.definition_parser.yaml.class%'
        arguments: []
        tags:
            - { name: ez_migration_bundle.definition_parser }

    ez_migration_bundle.definition_parser.json:
        class: '%ez_migration_bundle.definition_parser.json.class%'
        arguments: []
        tags:
            - { name: ez_migration_bundle.definition_parser }

    ez_migration_bundle.definition_parser.sql:
        class: '%ez_migration_bundle.definition_parser.sql.class%'
        arguments:
            - '%ez_migration_bundle.valid_databases%'
        tags:
            - { name: ez_migration_bundle.definition_parser }

    ez_migration_bundle.definition_parser.php:
        class: '%ez_migration_bundle.definition_parser.php.class%'
        arguments: []
        tags:
            - { name: ez_migration_bundle.definition_parser }

    ### storage handlers

    ez_migration_bundle.storage_handler:
        alias: ez_migration_bundle.storage_handler.database

    ez_migration_bundle.storage_handler.database:
        class: '%ez_migration_bundle.storage_handler.database.class%'
        arguments:
            - '@ezpublish.connection'
            - '%ez_migration_bundle.table_name%'

    ### executors

    ez_migration_bundle.executor.php:
        class: '%ez_migration_bundle.executor.php.class%'
        arguments:
            - '@service_container'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.sql:
        class: '%ez_migration_bundle.executor.sql.class%'
        arguments:
            - '@ezpublish.connection'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.repository:
        abstract: true
        class: '%ez_migration_bundle.executor.repository.class%'
        calls:
            - ['setRepository', ['@ezpublish.api.repository']]
            - ['setReferenceResolver', ['@ez_migration_bundle.reference_resolver.customreference']]

    ez_migration_bundle.executor.content_manager:
        parent: ez_migration_bundle.executor.repository
        class: '%ez_migration_bundle.executor.content_manager.class%'
        arguments:
            - '@ez_migration_bundle.content_matcher'
            - '@ez_migration_bundle.section_matcher'
            - '@ez_migration_bundle.user_matcher'
            - '@ez_migration_bundle.object_state_matcher'
            - '@ez_migration_bundle.complex_field_manager'
            - '@ez_migration_bundle.executor.location_manager'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.location_manager:
        parent: ez_migration_bundle.executor.repository
        class: '%ez_migration_bundle.executor.location_manager.class%'
        arguments:
            - '@ez_migration_bundle.content_matcher'
            - '@ez_migration_bundle.location_matcher'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.content_type_manager:
        parent: ez_migration_bundle.executor.repository
        class: '%ez_migration_bundle.executor.content_type_manager.class%'
        arguments:
            - '@ez_migration_bundle.content_type_matcher'
            - '@ez_migration_bundle.content_type_group_matcher'
            - '@ez_migration_bundle.reference_resolver'
            - '@ez_migration_bundle.complex_field_manager'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.content_type_group_manager:
        parent: ez_migration_bundle.executor.repository
        class: '%ez_migration_bundle.executor.content_type_group_manager.class%'
        arguments:
            - '@ez_migration_bundle.content_type_group_matcher'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.user_manager:
        parent: ez_migration_bundle.executor.repository
        class: '%ez_migration_bundle.executor.user_manager.class%'
        arguments:
            - '@ez_migration_bundle.user_matcher'
            - '@ez_migration_bundle.user_group_matcher'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.user_group_manager:
        parent: ez_migration_bundle.executor.repository
        class: '%ez_migration_bundle.executor.user_group_manager.class%'
        arguments:
            - '@ez_migration_bundle.user_group_matcher'
            - '@ez_migration_bundle.role_matcher'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.role_manager:
        class: '%ez_migration_bundle.executor.role_manager.class%'
        parent: ez_migration_bundle.executor.repository
        arguments:
            - '@ez_migration_bundle.role_matcher'
            - '@ez_migration_bundle.helper.limitation_converter'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.language_manager:
        class: '%ez_migration_bundle.executor.language_manager.class%'
        parent: ez_migration_bundle.executor.repository
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.tag_manager:
        parent: ez_migration_bundle.executor.repository
        class: '%ez_migration_bundle.executor.tag_manager.class%'
        arguments:
            - '@ez_migration_bundle.tag_matcher'
            - '@?ezpublish.api.service.tags'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.object_state_manager:
        class: '%ez_migration_bundle.executor.object_state_manager.class%'
        parent: ez_migration_bundle.executor.repository
        arguments:
            - '@ez_migration_bundle.object_state_matcher'
            - '@ez_migration_bundle.object_state_group_matcher'
        tags:
            - { name: ez_migration_bundle.executor }

    ez_migration_bundle.executor.object_state_group_manager:
        class: '%ez_migration_bundle.executor.object_state_group_manager.class%'
        parent: ez_migration_bundle.executor.repository
        arguments:
            - '@ez_migration_bundle.object_state_group_matcher'
        tags:
            - { name: ez_migration_bundle.executor }

    ### matchers

    ez_migration_bundle.content_matcher:
        class: '%ez_migration_bundle.content_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.location_matcher:
        class: '%ez_migration_bundle.location_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.user_matcher:
        class: '%ez_migration_bundle.user_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.user_group_matcher:
        class: '%ez_migration_bundle.user_group_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.role_matcher:
        class: '%ez_migration_bundle.role_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.content_type_matcher:
        class: '%ez_migration_bundle.content_type_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.section_matcher:
        class: '%ez_migration_bundle.section_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.object_state_matcher:
        class: '%ez_migration_bundle.object_state_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.object_state_group_matcher:
        class: '%ez_migration_bundle.object_state_group_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.content_type_group_matcher:
        class: '%ez_migration_bundle.content_type_group_matcher.class%'
        arguments:
            - '@ezpublish.api.repository'

    ez_migration_bundle.tag_matcher:
        class: '%ez_migration_bundle.tag_matcher.class%'
        arguments:
            - '@ezpublish.translation_helper'
            - '@?ezpublish.api.service.tags'

    ### field handlers

    ez_migration_bundle.complex_field_manager:
        class: '%ez_migration_bundle.complex_field_manager.class%'
        arguments:
             - '@ezpublish.api.service.field_type'

    ez_migration_bundle.complex_field:
        abstract: true
        calls:
            - ['setReferenceResolver', ['@ez_migration_bundle.reference_resolver.customreference']]

    # NB: you can register handlers for either a field type, using the  'fieldtype' attribute, or for the
    #     field type of a specific content type by using both 'fieldtype' and 'contenttype' in the tag definition

    ez_migration_bundle.complex_field.ezauthor:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezauthor.class%'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezauthor, priority: 0 }

    ez_migration_bundle.complex_field.ezbinaryfile:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezbinaryfile.class%'
        arguments:
            - "%ezpublish_legacy.root_dir%"
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezbinaryfile, priority: 0 }

    ez_migration_bundle.complex_field.ezboolean:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezboolean.class%'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezboolean, priority: 0 }

    ez_migration_bundle.complex_field.ezdate:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezdate.class%'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezdate, priority: 0 }

    ez_migration_bundle.complex_field.ezdatetime:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezdatetime.class%'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezdatetime, priority: 0 }

    ez_migration_bundle.complex_field.ezimage:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezimage.class%'
        arguments:
            - "%ezpublish_legacy.root_dir%"
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezimage, priority: 0 }

    ez_migration_bundle.complex_field.ezpage:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezpage.class%'
        arguments:
            - '@ezpublish.fieldType.ezpage.pageService'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezpage, priority: 0 }

    ez_migration_bundle.complex_field.ezrelation:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezrelation.class%'
        arguments:
            - '@ez_migration_bundle.content_matcher'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezobjectrelation, priority: 0 }

    ez_migration_bundle.complex_field.ezrelationlist:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezrelationlist.class%'
        arguments:
            - '@ez_migration_bundle.content_matcher'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezobjectrelationlist, priority: 0 }

    ez_migration_bundle.complex_field.ezrichtext:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezrichtext.class%'
        arguments:
            # if you want to replace custom references in rich text fields, you can replace this with a new service
            # built f.e. using the ChainPrefixResolver class
            - '@ez_migration_bundle.reference_resolver.customreference'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezrichtext, priority: 0 }

    ez_migration_bundle.complex_field.ezxmltext:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.ezxmltext.class%'
        arguments:
            # if you want to replace custom references in rich text fields, you can replace this with a new service
            # built f.e. using the ChainPrefixResolver class
            - '@ez_migration_bundle.reference_resolver.customreference'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: ezxmltext, priority: 0 }

    ez_migration_bundle.complex_field.eztags:
        parent: ez_migration_bundle.complex_field
        class: '%ez_migration_bundle.complex_field.eztags.class%'
        arguments:
            - '@ez_migration_bundle.tag_matcher'
        tags:
            - { name: ez_migration_bundle.complex_field, fieldtype: eztags, priority: 0 }

    ### reference resolvers

    # A service that will resolve *any* possible reference. To be used with care
    # At the moment is is only used to resolve references in definitions of FieldType settings, and even then, only
    # for backwards compatibility
    ez_migration_bundle.reference_resolver:
        alias: ez_migration_bundle.reference_resolver.chain

    ez_migration_bundle.reference_resolver.chain:
        class: '%ez_migration_bundle.reference_resolver.chain.class%'
        arguments:
            -
                - '@ez_migration_bundle.reference_resolver.customreference'
                - '@ez_migration_bundle.reference_resolver.location'
               # not enabled by default for v3, as it might break v1 migrations that don't expect it to be present
               #- '@ez_migration_bundle.reference_resolver.content'
                - '@ez_migration_bundle.reference_resolver.tag'

    # @deprecated
    ez_migration_bundle.reference_resolver.content:
        class: '%ez_migration_bundle.reference_resolver.content.class%'
        arguments:
            - '@ez_migration_bundle.content_matcher'

    ez_migration_bundle.reference_resolver.location:
        class: '%ez_migration_bundle.reference_resolver.location.class%'
        arguments:
            - '@ez_migration_bundle.location_matcher'

    ez_migration_bundle.reference_resolver.tag:
        class: '%ez_migration_bundle.reference_resolver.tag.class%'
        arguments:
            - '@ez_migration_bundle.tag_matcher'

    # A service which resolves *only* custom references. As such, it is used in most places
    ez_migration_bundle.reference_resolver.customreference:
        alias: ez_migration_bundle.reference_resolver.customreference.flexible

    ez_migration_bundle.reference_resolver.customreference.base:
        class: '%ez_migration_bundle.reference_resolver.customreference.class%'
        arguments: []

    # NB: This service will see added to the chain any service tagged as 'ez_migration_bundle.reference_resolver.customreference'
    ez_migration_bundle.reference_resolver.customreference.flexible:
        class: '%ez_migration_bundle.reference_resolver.chain_prefix.class%'
        arguments:
            - [ '@ez_migration_bundle.reference_resolver.customreference.base' ]

    ### misc

    # This service is used for the verbose mode when executing migrations on the command line
    ez_migration_bundle.step_executed_listener.tracing:
        class: '%ez_migration_bundle.step_executed_listener.tracing.class%'
        tags:
            - { name: kernel.event_listener, event: ez_migration.step_executed, method: onStepExecuted }

    ez_migration_bundle.helper.limitation_converter:
        class: '%ez_migration_bundle.helper.limitation_converter.class%'
        arguments:
            - '%ezpublish.siteaccess.list%'
            - '@ez_migration_bundle.location_matcher'
            - '@ez_migration_bundle.section_matcher'
            - '@ez_migration_bundle.content_type_matcher'

    ez_migration_bundle.helper.console_io:
        class: '%ez_migration_bundle.helper.console_io.class%'
        tags:
            - { name: kernel.event_listener, event: console.command }
