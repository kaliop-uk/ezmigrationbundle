name: CI

on: [push, pull_request]

jobs:
    test:
        runs-on: ${{ matrix.operating-system }}
        env:
            SYMFONY_ENV: behat
            DB_HOST: localhost
            DB_TYPE: mysql
            DB_ROOT_PASSWORD: root
            DB_EZ_USER: ezp
            DB_EZ_PASSWORD: ezp
            DB_EZ_DATABASE: behattestdb
        strategy:
            fail-fast: false
            matrix:
                # @see https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners for available os versions
                # @todo add some tests running on 'windows-latest'
                include:
                    - config_file: .euts.cp.env
                      operating-system: 'ubuntu-20.04'
                      code-coverage: ~
                    - config_file: .euts.1.7.env
                      operating-system: 'ubuntu-20.04'
                      code-coverage: ~
                    - config_file: .euts.1.13.env
                      operating-system: 'ubuntu-20.04'
                      code-coverage: ~
                    - config_file: .euts.2.3.env
                      operating-system: 'ubuntu-22.04'
                      code-coverage: ~
                    - config_file: .euts.2.4.env
                      operating-system: 'ubuntu-22.04'
                      code-coverage: ~
                    - config_file: .euts.2.5.env
                      operating-system: 'ubuntu-22.04'
                      code-coverage: codecov
        steps:
            -   name: checkout code
                uses: actions/checkout@v2

            # Although this action is useful, we prefer to use the same script to set up php that we use for the
            # docker image used for local testing. This allows us to make sure that the script is always in good shape
            #-
            #    uses: shivammathur/setup-php@v2
            #    with:
            #        php-version: ${{ matrix.php }}
            #        extensions: curl, dom, mbstring, xsl
            #        ini-values: 'cgi.fix_pathinfo=1, always_populate_raw_post_data=-1'
            #        #tools: phpunit/phpunit:a_version_compatible_with_php_5.3-5.5
            #        # NB: this disables xdebug completely
            #        coverage: none

            -   name: get the teststack, set it up and run tests
                uses: tanoconsulting/euts@b88656ea95324d5440b4a8d98a14f8501cb38665
                with:
                    configuration-file: Tests/environment/${{ matrix.config_file }}
                    code-coverage-service: ${{ matrix.code-coverage }}
                    repo-token: ${{ secrets.GITHUB_TOKEN }}

            -   name: troubleshoot
                if: ${{ failure() }}
                run: |
                    #env
                    #php -i
                    #systemctl list-units --all --type=service --no-pager | grep running
                    #ps auxwww
                    #dpkg --list | grep php
                    #pwd
                    #sudo env
                    #ls -ltr /var/log
                    sudo cat /var/log/php*.log
